using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.UI;
using Photon.Pun;

//原生之石：使敌人回到出发点

public class OriginStone : MonoBehaviourPunCallbacks
{
    [SerializeField]
    ToolMenuControl toolMenuControl;
    CharacterItems characterItems;
    CharacterStatus characterStatus;
    GameObject curPlayer;
    [SerializeField] private float minDis = 3.0f; //在这个距离内才能影响到敌人
    private GameObject[] players;
    ToolSound toolSound;
    //public Text SliderText;
    public Text K1;
    public Text K2;
    public Text K3;
    string Playername;
    GameObject k1;
    GameObject k2;
    GameObject k3;
    Killfeed killfeed;
    GameObject achieve;
    private void Start()
    {
        curPlayer = GameObject.Find("Player(Clone)");
        characterItems = curPlayer.GetComponent<CharacterItems>();
        characterStatus = curPlayer.GetComponent<CharacterStatus>();
        toolSound = curPlayer.GetComponent<ToolSound>();
        K1 = GameObject.Find("Canvas/Killfeed/K1/Text").GetComponent<Text>();
        K2 = GameObject.Find("Canvas/Killfeed/K2/Text").GetComponent<Text>();
        K3 = GameObject.Find("Canvas/Killfeed/K3/Text").GetComponent<Text>();
        Playername = curPlayer.GetComponent<CharacterStatus>().username;
        k1 = GameObject.Find("Canvas/Killfeed/K1");
        k2 = GameObject.Find("Canvas/Killfeed/K2");
        k3 = GameObject.Find("Canvas/Killfeed/K3");
        killfeed = GameObject.Find("Canvas").GetComponent<Killfeed>();
        achieve = GameObject.Find("AchievementManager");
        //SliderText = GameObject.Find("Canvas/slider/SliderImage/SliderText").GetComponent<Text>();
    }


    public void onClicked()
    {
        if(characterItems.getOriginStone() == 0)
        {
            //执行文字提示
            //
            return;
        }
        Debug.Log("222 " + curPlayer.transform.position);
        PhotonView.RPC("showOriginEffect", RpcTarget.MasterClient, curPlayer.transform.position, curPlayer.GetComponent<CapsuleCollider>().center, curPlayer.transform.localScale.y);
        PhotonView.RPC("showOriginTips", RpcTarget.All, Playername);
        achieve.GetComponent<SimpleAchievements.Main.AchievementsControl>().AddProgressAchievementByID(5, 1);
        //现在的设定是只要是一定范围内的敌人都会被影响
        players = GameObject.FindGameObjectsWithTag("Player");
        Vector3 position = (players[0].transform.position);
        for(int i = 1; i < players.Length; i++)
        {
            Debug.Log(players[i].name);
            
            float dis = Vector3.Distance(players[i].transform.position, position);

            if (dis < minDis)
            {
                Debug.Log(players[i].GetComponent<PhotonView>().ViewID);
                //if (gameObject.Equals(players[i]))
                //{
                //    break;
                //}
                toolSound.Teleport(curPlayer.GetComponent<PhotonView>().ViewID);
                PhotonView.RPC("BackToOrigin", RpcTarget.All, players[i].GetComponent<PhotonView>().ViewID);
                //players[i].GetComponent<CharacterStatus>().BackToOrigin();
            }
        }
        
        characterItems.changeOriginStone(-1);
        toolMenuControl.transparent();
    }

    [PunRPC]
    public void BackToOrigin(int viewID)
    {
        Debug.Log("origin rpc");
        //当受到对手的原生之石的影响后，回到出发点
        PhotonView.Find(viewID).transform.position = new Vector3(0f, 10f, -42f);
        //PhotonNetwork.Destroy(PhotonView.Find(viewID));
    }

    [PunRPC]
    public void showOriginEffect(Vector3 position, Vector3 center, float scale)
    {
        Vector3 centerPos = position + center * scale * 1.5f;
        PhotonNetwork.Instantiate("Effects/OriginEffect", centerPos, Quaternion.identity, 0);
    }

    [PunRPC]
    public void showOriginTips(string name)
    {
        if (killfeed.textcount == 0)
        {
            k1.SetActive(true);
        }
        else if (killfeed.textcount == 1)
        {
            k2.SetActive(true);
        }
        else if (killfeed.textcount == 2)
        {
            k3.SetActive(true);
        }
        if (K1.text == "")
        {
            K1.text = "<i>" + name + "</i> 使用了 <color=#73ccd5ff>源生之石</color> ";
        }
        else if (K2.text == "")
        {
            K2.text = "<i>" + name + "</i> 使用了 <color=#73ccd5ff>源生之石</color> ";
        }
        else if (K3.text == "")
        {
            K3.text = "<i>" + name + "</i> 使用了 <color=#73ccd5ff>源生之石</color> ";
        }
        else
        {
            K1.text = K2.text;
            K2.text = K3.text;
            K3.text = "<i>" + name + "</i> 使用了 <color=#73ccd5ff>源生之石</color> ";
        }
        killfeed.textcount++;
    }
}
